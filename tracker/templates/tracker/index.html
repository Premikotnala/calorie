{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Calorie Tracker</title>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css"
          crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@2.9.3/dist/Chart.min.js"></script>
</head>
<body>
<div class="container">
    <!-- Navbar -->
    <nav class="navbar navbar-dark bg-info mb-3">
        <a href="{% url 'index' %}" class="navbar-brand">Calorie Tracker</a>
        <div class="ml-auto">
            {% if request.user.is_authenticated %}
                <span class="text-white mr-3">Welcome, {{ request.user.username }}</span>
                <a href="{% url 'logout' %}" class="btn btn-light btn-sm">Logout</a>
            {% else %}
                <a href="{% url 'login' %}" class="btn btn-light btn-sm">Login</a>
                <a href="{% url 'register' %}" class="btn btn-outline-light btn-sm">Register</a>
            {% endif %}
        </div>
    </nav>

    <!-- Add Food Form -->
    <div class="row justify-content-center mb-4">
        <div class="col-md-8">
            <form method="POST" class="form-inline justify-content-center">
                {% csrf_token %}
                <label class="mr-2"><b>Select Food To Add:</b></label>
                <select class="form-control mr-2" name="food_consumed" id="food_consumed">
                    {% for food in foods %}
                        <option value="{{ food.id }}">{{ food.name }}</option>
                    {% endfor %}
                </select>
                <button class="btn btn-success" type="submit">Add</button>
            </form>
        </div>
    </div>

    <!-- Progress Bar -->
    <h3 class="text-center">Calorie Goal</h3>
    <div class="row mb-4">
        <div class="col-md-10 offset-md-1">
            <div class="progress">
                <div class="progress-bar bg-success" role="progressbar"
                     style="width: 0%" aria-valuenow="0" aria-valuemin="0" aria-valuemax="2000"></div>
            </div>
            <p class="text-center mt-2">Daily Goal: 2000 kcal</p>
        </div>
    </div>

    <div class="row">
        <!-- Food Table -->
        <div class="col-md-7">
            <h4 class="text-center">Today's Consumption</h4>
            <table id="table" class="table table-striped table-bordered">
                <tr class="bg-info text-white text-center">
                    <th>Food item</th>
                    <th>Carbs (g)</th>
                    <th>Protein (g)</th>
                    <th>Fats (g)</th>
                    <th>Calories (kcal)</th>
                    <th>Remove</th>
                </tr>
                {% for c in consumed_food %}
                    <tr class="text-center">
                        <td>{{ c.food_consumed.name }}</td>
                        <td>{{ c.food_consumed.carbs }}</td>
                        <td>{{ c.food_consumed.protein }}</td>
                        <td>{{ c.food_consumed.fats }}</td>
                        <td>{{ c.food_consumed.calories }}</td>
                        <td>
                            <form method="POST" action="{% url 'delete' c.id %}">
                                {% csrf_token %}
                                <button type="submit" class="btn btn-danger btn-sm">X</button>
                            </form>
                        </td>
                    </tr>
                {% endfor %}
                <tr class="bg-info text-white text-center">
                    <td><b>Total</b></td>
                    <td id="totalCarbs"><b>0</b></td>
                    <td id="totalProtein"><b>0</b></td>
                    <td id="totalFats"><b>0</b></td>
                    <td id="totalCalories"><b>0</b></td>
                    <td>-</td>
                </tr>
            </table>
        </div>

        <!-- Chart -->
        <div class="col-md-5">
            <h4 class="text-center">Today's Breakdown</h4>
            <div class="card">
                <div class="card-header bg-info text-white text-center">
                    Nutrients Breakdown
                </div>
                <div class="card-body">
                    <canvas id="myChart" width="400" height="400"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    var table = document.getElementById("table");
    var carbs = 0, protein = 0, fats = 0, calories = 0;

    for (var i = 1; i < table.rows.length - 1; i++) {
        carbs += parseFloat(table.rows[i].cells[1].innerHTML);
        protein += parseFloat(table.rows[i].cells[2].innerHTML);
        fats += parseFloat(table.rows[i].cells[3].innerHTML);
        calories += parseFloat(table.rows[i].cells[4].innerHTML);
    }

    document.getElementById("totalCarbs").innerHTML = '<b>' + Math.round(carbs) + '</b>';
    document.getElementById("totalProtein").innerHTML = '<b>' + Math.round(protein) + '</b>';
    document.getElementById("totalFats").innerHTML = '<b>' + Math.round(fats) + '</b>';
    document.getElementById("totalCalories").innerHTML = '<b>' + Math.round(calories) + '</b>';

    var calPer = (calories / 2000) * 100;
    document.getElementsByClassName("progress-bar")[0].style.width = calPer + "%";

    var total = carbs + protein + fats;
    var carbsP = total ? Math.round((carbs / total) * 100) : 0;
    var proteinP = total ? Math.round((protein / total) * 100) : 0;
    var fatsP = total ? Math.round((fats / total) * 100) : 0;

    var ctx = document.getElementById('myChart').getContext('2d');
    new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: ['Carbs ' + carbsP + '%', 'Protein ' + proteinP + '%', 'Fats ' + fatsP + '%'],
            datasets: [{
                data: [carbsP, proteinP, fatsP],
                backgroundColor: ['#FF6384', '#36A2EB', '#FFCE56'],
                borderColor: ['#FF6384', '#36A2EB', '#FFCE56'],
                borderWidth: 1
            }]
        }
    });
</script>
</body>
</html>
